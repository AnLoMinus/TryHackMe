![image](https://user-images.githubusercontent.com/51442719/198373510-b66a65a8-8df8-4125-bef0-b0dcac0f58d8.png)

# [PowerShell for Pentesters](https://tryhackme.com/room/powershellforpentesters)
#### This room covers the principle uses of PowerShell in Penetration Tests. Interacting with files, scanning the network and system enumeration are covered.

- [Task 1  Intro](#)
- [Task 2  Manipulating files](#)
- [Task 3  Downloading files](#)
- [Task 4  System Reconnaissance](#)
- [Task 5  Network Reconnaissance](#)
- [Task 6  Using PowerView](#)

---

# Task 1  Intro

---

# Task 2  Manipulating files

---

# Task 3  Downloading files

There are numerous ways to download files from a remote server using PowerShell. One of the quickest ways can be seen below. This will connect to the remote host (10.0.2.8 in this case) and download `themeterpreter-64.ps1`. The file is saved as “`meterpreter.ps1`”.



The screenshot below shows a sample lab setup used with Kali running a Python HTTP server on port 8888 (python3 -m http.server 8888).

![image](https://user-images.githubusercontent.com/51442719/198377051-3c893912-6b56-447c-886f-8765d3a477a0.png)

Once the script has been downloaded, you may run into the first related to PowerShell: ExecutionPolicy. It is important to note that, as Microsoft clearly states in the related documentation, “`ExecutionPolicy`” is NOT a security feature. It merely functions as an added safety measure and can be bypassed by the user.

![image](https://user-images.githubusercontent.com/51442719/198377120-87559081-f74b-4ee5-84f9-afab7aa243de.png)

The current state of the ExecutionPolicy configuration can be seen using “`Get-ExecutionPolicy -list`”

Execution policies can have seven different values;

- `AllSigned`: Scripts can run but require all scripts to be signed by a trusted publisher.
- `Bypass`: All scripts can run, and no warnings or prompts will be displayed.
- `Default`: This refers to “restricted” for Windows clients and “RemoteSigned” for Windows servers.
- `RemoteSigned`: Scripts can run, and this does not require local scripts to be digitally signed.
- `Restricted`: The default configuration for Windows clients. Allows individual commands to run, does not allow scripts.
- `Undefined`: This shows that no specific execution policy was set. This means default execution policies will be enforced.
- `Unrestricted`: Most scripts will run.

As mentioned earlier, ExecutionPolicy is not a security feature and can be bypassed by users. The user has several alternatives to bypass the ExecutionPolicy; however, some methods may require the user to have administrator account privileges.

The most common way to bypass execution policy can be seen below:

![image](https://user-images.githubusercontent.com/51442719/198377364-1ecb188d-2eb5-48a4-9e55-db4f1579284c.png)

Another option could be to use “`Set-ExecutionPolicy Bypass`” with the scope set for the process. The “`-scope`” parameter will set the execution policy only for the current PowerShell session and will go back to the initial settings once the PowerShell session is closed.

![image](https://user-images.githubusercontent.com/51442719/198377457-0dc6382f-ea13-4b8b-88ec-1b817fe8949a.png)

Another easy way to download files from a remote server is to use the “`Invoke-WebRequest`” command.

![image](https://user-images.githubusercontent.com/51442719/198377496-4e38ecd1-2b71-4869-af3b-c9aefdfd9567.png)

---

# Task 4  System Reconnaissance

While several PowerShell scripts are readily available for reconnaissance, these may be flagged by the antivirus installed on the target system.

Finding Missing Patches

The patch level of the target system will have an impact on the steps following the initial compromise. Having an idea about the potentially missing patches could help the red teamer identify a possible privilege escalation path or even provide further information about the target system.

The “`Get-Hotfix`” command can be used to enumerate already installed patches.

![image](https://user-images.githubusercontent.com/51442719/198377626-a289767a-d260-42c9-8d9f-bfbd5eaa91a9.png)

To make things easier, we could output the result of the Get-Hotfix command in a list format and grep it further using the “`findstr`” command. The example below shows how the installation date of patches could be listed to have a better idea about update cycles on the target.

![image](https://user-images.githubusercontent.com/51442719/198377699-0512fd18-af64-4867-8fd3-3f5950c75202.png)

By default, the “`Get-HotFix`” command will show the output in a table format. This table can be useful to list only data provided in a column without the need to use “`findstr`” using “`Format-Table`” followed by the name of the column we are interested in. The example below shows the output listing only HotFixIDs.

![image](https://user-images.githubusercontent.com/51442719/198377851-6b79223a-93a4-43ad-aa3c-3faae844bbba.png)

“Format-List” can also be used to gather more information about objects. Below are three examples using a simple “dir” command.

![image](https://user-images.githubusercontent.com/51442719/198378071-e0c6d96a-46cb-4393-bcad-32958e7198b4.png)

![image](https://user-images.githubusercontent.com/51442719/198378085-f00b8158-c8bb-4a5e-9de4-6f45f8d47c11.png)

![image](https://user-images.githubusercontent.com/51442719/198378104-2d6b0eec-01fc-4720-8585-b238a06b84c6.png)

As you can see, we can access even more information about the file (such as the CreationTime, Last AccessTime, LastWriteTime) using a wildcard after “`Format-List`” to show all available information.

At any stage, “`Out-File`” can be used to save the output to a file for further use.

![image](https://user-images.githubusercontent.com/51442719/198378171-f58929a3-24b3-486a-8688-fce65b554055.png)

“`Get-Content`” could also be used to read the file's content just as “type” shown in the example above. Several other output formats are available, including the beautiful GridView option.

![image](https://user-images.githubusercontent.com/51442719/198378238-de18a56d-b68e-4c40-afd4-7ea0cb6a6c3e.png)

The GridView option provides a nice GUI with sortable columns for any output that can be overwhelming on the CLI.

![image](https://user-images.githubusercontent.com/51442719/198378285-f7aca7b4-7b78-43e4-9fe9-b463a598b436.png)

---

# Task 5  Network Reconnaissance

The following command can be used to ping a given IP range. In this example, we will ping the IP addresses from 10.0.2.1 to 10.0.2.15

![image](https://user-images.githubusercontent.com/51442719/198379534-7352c88c-78d3-4c58-a065-49c3a2efe77d.png)

The first part of the command, delimited by the "|" character, sets the range for the last octet. The second part generates and prints the IP address to be used and pipes it to the command line. Finally, the last part greps lines that include the “TTL” string.


A similar command can be built using the existing socket and TCP client functions. In the example below, we scan the first 1024 TCP ports of the target. Note that the “`2>$null`” sends any error to null, providing us with a cleaner output.

![image](https://user-images.githubusercontent.com/51442719/198379603-9da3221d-1502-4942-b5af-9a577e746ddc.png)

---

# Task 6  Using PowerView

PowerView is one of the most effective ways to gather information on the domain. The module can be downloaded from https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1


Remember that you may need to bypass the execution policy to be able to run the script.

![image](https://user-images.githubusercontent.com/51442719/198379898-889ec916-1fa3-425d-b502-9874dad25ee6.png)

We can now use `PowerView.ps1` to obtain more information on the domain configuration and users.

`Get-NetDomainController`

This command will collect information on the domain controller.

![image](https://user-images.githubusercontent.com/51442719/198380071-612406bf-e4bf-4e37-a304-841d3464d678.png)

Knowing the IP address of the domain controller will be useful to conduct man-in-the-middle attacks and to focus our efforts on high-value targets.

`Get-NetUser`

This command will provide a list of domain users. The output can be intimidating, so you may consider exporting the output to a .csv file or use the `out-gridviewoption`.

![image](https://user-images.githubusercontent.com/51442719/198380261-dbe2ba5a-16a4-49b6-849a-10a6daad0492.png)

The output can also be limited by providing the name of the criteria we are interested in.

![image](https://user-images.githubusercontent.com/51442719/198380282-3ba2895c-d491-4221-ab50-b951bfcb6a22.png)

Values for a specific property can be listed. For example, if we wanted to list users' last logon dates and times we could use the "`Get-NetUser | select -ExpandProperty lastlogon`" command.

![image](https://user-images.githubusercontent.com/51442719/198380360-5ae73e2a-d19d-44b4-b334-24040702ec3e.png)

The same command can be modified to select the "description" field instead of "lastlogon" to see if any description was added to accounts.

`Get-NetComputer`

This command is useful to enumerate systems connected to the domain. This command can also be used with the “`-ping`” parameter to enumerate the systems that are currently online.

![image](https://user-images.githubusercontent.com/51442719/198380869-fac61508-1d50-4b5e-9796-120c6600200d.png)

As you can see in the screenshot above, there are four systems on the domain, but only two of them are online.

`Get-NetGroup`

Some accounts can be members of important groups, such as domain admins. Knowing which accounts have useful privileges or are a member of groups of interest will be useful for lateral movement and privilege escalation. The “`Get-NetGroup`” command will help us enumerate existing groups.

![image](https://user-images.githubusercontent.com/51442719/198380610-2332c423-f7ff-43c1-9315-241195e7dce0.png)

This will be used to enumerate members of the group using “`Get-NetGroupMember`” followed by "`Domain Admins`".

![image](https://user-images.githubusercontent.com/51442719/198381197-898d5bac-9a09-4051-8f66-c1db1266522c.png)


Finding shares

“`Find-DomainShare`” will list available shares. Please note we have added the "`-CheckShareAccess`" option to list only readable shares.

![image](https://user-images.githubusercontent.com/51442719/198381317-21c633ef-b4d9-448b-aae8-1cd7c7bc17ef.png)


Enumerate Group Policy

Group Policy is used to configure computers connected to the domain. The “`Get-NetGPO`” command will gather information on enforced policies.

![image](https://user-images.githubusercontent.com/51442719/198381393-899219e9-648e-4f6f-971f-49c211a3631e.png)

Spending some time understanding what policies are set can provide potential attack vectors (is Windows Defender disabled? Is the firewall disabled? Etc.)


The domain you are testing can have a trust relationship with another domain. If this is the case, you may be able to extend the scope of the reconnaissance to that domain. The “`Get-NetDomainTrust`” command will list any domain you may access. For most of the PowerView commands, all you need to do is to add the “`-Domain`” parameter followed by the name of the other domain (e.g. `Get-NetUsers -Domain infra.munn.local`)


User Enumeration

Knowing which systems the current user can access with local administrator privileges can facilitate lateral movement. The “`Find-LocalAdminAccess`” command will list systems in the domain you may access as a local administrator.

![image](https://user-images.githubusercontent.com/51442719/198381530-d8851301-ad13-4522-80a4-56b0bcae5e54.png)

A good source for PowerView usage can be found [here](https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters/powerview).

---
3---

## Writeups
- [TryHackMe: PowerShell for Pentesters (Difficulty: Medium)](https://hamdisevben.medium.com/tryhackme-powershell-for-pentesters-b31a3036ec2)
